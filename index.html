<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guest WiFi Access</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: #f4f6f8; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            height: 100vh; 
            margin: 0;
        }
        .container { 
            background: white; 
            width: 90%; 
            max-width: 400px; 
            padding: 30px; 
            border-radius: 12px; 
            text-align: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
        }
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            box-sizing: border-box; 
        }
        button { 
            width: 100%; 
            padding: 14px; 
            background-color: #5c0f8b; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 15px; 
        }
        button:disabled { background-color: #ccc; }
        .error-msg { color: red; font-size: 12px; margin-top: 10px; display: none; }
        .debug-info { font-size: 10px; color: #aaa; margin-top: 20px; display: none; text-align: left; }
    </style>
</head>
<body>

    <div class="container">
        <h2>WiFi Login</h2>
        <p>Please sign in to continue.</p>
        
        <input type="text" id="name" placeholder="Full Name" required>
        <input type="email" id="email" placeholder="Email Address" required>
        
        <button id="connectBtn" onclick="handleLogin()">Connect to Internet</button>
        <p id="error" class="error-msg">Missing configuration parameters.</p>
        
        <div id="debug" class="debug-info"></div>
    </div>

    <form id="authForm" method="POST">
        <input type="hidden" name="opcode" value="cp_ack">
        <input type="hidden" id="auth_orig_url" name="orig_url" value="">
    </form>

    <script>
        const WEBHOOK_URL = "https://webhook.site/6590fb2c-9009-4dd0-9b86-f04b1537ef34";

        // Global variable to store the AP's login URL
        let apLoginUrl = "";

        // 1. ON LOAD: Capture the parameters sent by the AP
        document.addEventListener("DOMContentLoaded", function() {
            const params = new URLSearchParams(window.location.search);
            const debug = document.getElementById('debug');
            
            // A. Get the 'switch_url' (Where we submit the form)
            // Aruba usually sends 'switch_url', but sometimes 'login_url'
            apLoginUrl = params.get('switch_url') || params.get('login_url');
            
            // B. Get the 'orig_url' (Where the user wanted to go)
            // Aruba sends this so we can redirect them back after login
            const origUrl = params.get('orig_url') || params.get('url') || params.get('redirect');

            // C. Populate the hidden form
            if (apLoginUrl) {
                // Ensure the URL is decoded properly
                document.getElementById('authForm').action = decodeURIComponent(apLoginUrl);
            } else {
                document.getElementById('error').style.display = 'block';
                document.getElementById('connectBtn').disabled = true;
                debug.innerHTML += "ERROR: No switch_url found in address bar.<br>";
            }

            if (origUrl) {
                document.getElementById('auth_orig_url').value = origUrl;
            }

            // DEBUGGING: Show what we received (Remove 'display:none' from CSS to see this)
            debug.innerHTML += `<b>AP URL:</b> ${apLoginUrl}<br><b>Orig URL:</b> ${origUrl}`;
        });

        function handleLogin() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const btn = document.getElementById('connectBtn');

            if (!name || !email) {
                alert("Please fill in all fields");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Authenticating...";

            // 2. Send Data to Webhook (Background)
            const payload = JSON.stringify({
                name: name,
                email: email,
                timestamp: new Date().toISOString()
            });

            if (navigator.sendBeacon) {
                navigator.sendBeacon(WEBHOOK_URL, payload);
            } else {
                fetch(WEBHOOK_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: payload
                });
            }

            // 3. Submit to Aruba AP
            // We wait 500ms to ensure the webhook has time to leave the browser
            setTimeout(() => {
                if(apLoginUrl) {
                    document.getElementById('authForm').submit();
                } else {
                    alert("Error: Cannot connect. The WiFi system did not provide a login URL.");
                }
            }, 500);
        }
    </script>
</body>
</html>